name: test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  check-syntax:
    runs-on: self-hosted
    name: check-syntax
    # Source code for this image: https://github.com/scrive/devops-container-test-images
    container: 720173602891.dkr.ecr.eu-west-1.amazonaws.com/devops-tests:centos8-ansible-2.10.7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Check syntax of ansible playbook
        run: ansible-playbook /etc/ansible/roles/ansible-role-openvpn/tests/test.yml --syntax-check

  build-centos:
    runs-on: self-hosted
    needs: [ check-syntax ]
    # Source code for this image: https://github.com/scrive/devops-container-test-images
    container: 720173602891.dkr.ecr.eu-west-1.amazonaws.com/devops-tests:centos8-ansible-2.10.7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Make sure ansible connection is sane
        run: ansible -m setup -c local -i 127.0.0.1, all

      - name: Run ansible playbook
        run: ansible-playbook /etc/ansible/roles/ansible-role-openvpn/tests/test.yml -vv

      - name: Check idempotency
        run: ansible-playbook /etc/ansible/roles/ansible-role-openvpn/tests/test.yml -vv

      - name: Container state debug output
        continue-on-error: true
        run: |
            ls -lR /etc/openvpn
            echo "cat openvpn_udp_1194.conf"
            find /etc/openvpn/ -maxdepth 3 -name openvpn_udp_1194.conf -type f -exec cat {} \;
            echo "cat alpha-*.ovpn"
            find /etc/openvpn/ -maxdepth 3 -name "alpha-*.ovpn" -type f -exec cat {} \;
